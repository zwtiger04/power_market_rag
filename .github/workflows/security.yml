name: Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œì— ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰
    - cron: '0 2 * * 1'

jobs:
  # ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
  dependency-security:
    runs-on: ubuntu-latest
    name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit
        pip install -r requirements.txt
    
    - name: Safety ë³´ì•ˆ ê²€ì‚¬
      run: |
        safety check --json --output safety-report.json || true
        safety check
    
    - name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: safety-report
        path: safety-report.json

  # ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬
  code-security:
    runs-on: ubuntu-latest
    name: ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Bandit ë³´ì•ˆ ê²€ì‚¬
      run: |
        pip install bandit[toml]
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -ll
    
    - name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: bandit-report
        path: bandit-report.json

  # ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ê²€ì‚¬
  container-security:
    runs-on: ubuntu-latest
    name: ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ê²€ì‚¬
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
      run: docker build -t power-market-rag:security-scan .
    
    - name: Trivy ì»¨í…Œì´ë„ˆ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'power-market-rag:security-scan'
        format: 'sarif'
        output: 'trivy-results.sarif'
    
    - name: Trivy íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº”
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-fs-results.sarif'
    
    - name: ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
    
    - name: íŒŒì¼ì‹œìŠ¤í…œ ìŠ¤ìº” ê²°ê³¼ ì—…ë¡œë“œ
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-fs-results.sarif'

  # ë¹„ë°€ ì •ë³´ ê²€ì‚¬
  secrets-scan:
    runs-on: ubuntu-latest
    name: ë¹„ë°€ ì •ë³´ ê²€ì‚¬
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: TruffleHog ë¹„ë°€ ê²€ì‚¬
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # OWASP ZAP ë™ì  ë³´ì•ˆ í…ŒìŠ¤íŠ¸
  dynamic-security:
    runs-on: ubuntu-latest
    name: ë™ì  ë³´ì•ˆ í…ŒìŠ¤íŠ¸ (OWASP ZAP)
    if: github.event_name == 'schedule' || contains(github.event.head_commit.message, '[security-scan]')
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: power_market_rag_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test123
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
      run: |
        cp .env.example .env
        echo "DATABASE_URL=postgresql://test:test123@localhost:5432/power_market_rag_test" >> .env
        echo "REDIS_URL=redis://localhost:6379/0" >> .env
        echo "JWT_SECRET_KEY=test-secret-key-for-security-scan" >> .env
    
    - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œìž‘
      run: |
        python -m uvicorn api.api_server:app --host 0.0.0.0 --port 8000 &
        sleep 10
    
    - name: ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.10.0
      with:
        target: 'http://localhost:8000'
        rules_file_name: '.zap/rules.tsv'
        cmd_options: '-a'
    
    - name: ZAP ê²°ê³¼ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: zap-report
        path: report_html.html

  # License ê²€ì‚¬
  license-check:
    runs-on: ubuntu-latest
    name: ë¼ì´ì„ ìŠ¤ ê²€ì‚¬
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: pip-licenses ì„¤ì¹˜
      run: pip install pip-licenses
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ë¼ì´ì„ ìŠ¤ ê²€ì‚¬
      run: |
        pip-licenses --format=json --output-file=licenses.json
        pip-licenses --format=table
    
    - name: í—ˆìš©ë˜ì§€ ì•Šì€ ë¼ì´ì„ ìŠ¤ ê²€ì‚¬
      run: |
        python -c "
        import json
        with open('licenses.json') as f:
            licenses = json.load(f)
        
        # í—ˆìš©ë˜ì§€ ì•Šì€ ë¼ì´ì„ ìŠ¤ ëª©ë¡
        forbidden_licenses = ['GPL-3.0', 'AGPL-3.0', 'LGPL-3.0']
        
        violations = []
        for package in licenses:
            if package['License'] in forbidden_licenses:
                violations.append(f'{package[\"Name\"]} ({package[\"License\"]})')
        
        if violations:
            print('âš ï¸  í—ˆìš©ë˜ì§€ ì•Šì€ ë¼ì´ì„ ìŠ¤ ë°œê²¬:')
            for violation in violations:
                print(f'  - {violation}')
            exit(1)
        else:
            print('âœ… ëª¨ë“  ë¼ì´ì„ ìŠ¤ê°€ í—ˆìš©ë¨')
        "
    
    - name: ë¼ì´ì„ ìŠ¤ ë³´ê³ ì„œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: license-report
        path: licenses.json

  # ë³´ì•ˆ ì •ì±… ê²€ì‚¬
  security-policy:
    runs-on: ubuntu-latest
    name: ë³´ì•ˆ ì •ì±… ê²€ì‚¬
    
    steps:
    - uses: actions/checkout@v4
    
    - name: ë³´ì•ˆ ì •ì±… íŒŒì¼ ê²€ì‚¬
      run: |
        echo "ðŸ“‹ ë³´ì•ˆ ì •ì±… íŒŒì¼ ê²€ì‚¬..."
        
        # í•„ìˆ˜ ë³´ì•ˆ íŒŒì¼ë“¤ í™•ì¸
        files_to_check=(
          "SECURITY.md"
          ".github/SECURITY.md"
          ".gitignore"
          ".env.example"
          "pyproject.toml"
        )
        
        missing_files=()
        for file in "${files_to_check[@]}"; do
          if [[ ! -f "$file" ]]; then
            missing_files+=("$file")
          fi
        done
        
        if [[ ${#missing_files[@]} -gt 0 ]]; then
          echo "âš ï¸  ëˆ„ë½ëœ ë³´ì•ˆ ê´€ë ¨ íŒŒì¼:"
          printf '  - %s\n' "${missing_files[@]}"
        else
          echo "âœ… ëª¨ë“  í•„ìˆ˜ ë³´ì•ˆ íŒŒì¼ì´ ì¡´ìž¬í•¨"
        fi
    
    - name: í™˜ê²½ ë³€ìˆ˜ ê²€ì‚¬
      run: |
        echo "ðŸ” í™˜ê²½ ë³€ìˆ˜ ë³´ì•ˆ ê²€ì‚¬..."
        
        # .env íŒŒì¼ì´ ìžˆìœ¼ë©´ ì•ˆë¨ (ì‹¤ì œ í™˜ê²½ ë³€ìˆ˜)
        if [[ -f ".env" ]]; then
          echo "âŒ .env íŒŒì¼ì´ ì €ìž¥ì†Œì— í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤!"
          exit 1
        fi
        
        # .env.exampleì— ì‹¤ì œ ë¹„ë°€ ê°’ì´ ìžˆëŠ”ì§€ í™•ì¸
        if [[ -f ".env.example" ]]; then
          if grep -q "your_.*_here\|change.*production\|example\|test" .env.example; then
            echo "âœ… .env.exampleì— í”Œë ˆì´ìŠ¤í™€ë” ê°’ ì‚¬ìš©"
          else
            echo "âš ï¸  .env.exampleì— ì‹¤ì œ ë¹„ë°€ ê°’ì´ í¬í•¨ë  ìˆ˜ ìžˆìŠµë‹ˆë‹¤"
          fi
        fi
    
    - name: Docker ë³´ì•ˆ ì„¤ì • ê²€ì‚¬
      run: |
        echo "ðŸ³ Docker ë³´ì•ˆ ì„¤ì • ê²€ì‚¬..."
        
        if [[ -f "Dockerfile" ]]; then
          # ë£¨íŠ¸ ì‚¬ìš©ìž ì‚¬ìš© ê²€ì‚¬
          if grep -q "USER root\|^USER 0" Dockerfile; then
            echo "âš ï¸  Dockerfileì—ì„œ root ì‚¬ìš©ìž ì‚¬ìš© ë°œê²¬"
          fi
          
          # ë¹„ë°€ ì •ë³´ ë³µì‚¬ ê²€ì‚¬
          if grep -q "COPY.*\.env\|ADD.*\.env" Dockerfile; then
            echo "âŒ Dockerfileì—ì„œ .env íŒŒì¼ ë³µì‚¬ ë°œê²¬!"
            exit 1
          fi
          
          echo "âœ… Docker ë³´ì•ˆ ì„¤ì • ê²€ì‚¬ ì™„ë£Œ"
        fi

  # ì¢…í•© ë³´ì•ˆ ë³´ê³ ì„œ
  security-summary:
    runs-on: ubuntu-latest
    name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½
    needs: [dependency-security, code-security, container-security, license-check, security-policy]
    if: always()
    
    steps:
    - name: ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½
      run: |
        echo "# ðŸ”’ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ê²€ì‚¬ í•­ëª© | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ì˜ì¡´ì„± ë³´ì•ˆ | ${{ needs.dependency-security.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ì½”ë“œ ë³´ì•ˆ | ${{ needs.code-security.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ì»¨í…Œì´ë„ˆ ë³´ì•ˆ | ${{ needs.container-security.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ë¼ì´ì„ ìŠ¤ ê²€ì‚¬ | ${{ needs.license-check.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ë³´ì•ˆ ì •ì±… | ${{ needs.security-policy.result == 'success' && 'âœ… í†µê³¼' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ì „ì²´ ê²°ê³¼ ê²°ì •
        if [[ "${{ needs.dependency-security.result }}" == "success" && \
              "${{ needs.code-security.result }}" == "success" && \
              "${{ needs.container-security.result }}" == "success" && \
              "${{ needs.license-check.result }}" == "success" && \
              "${{ needs.security-policy.result }}" == "success" ]]; then
          echo "## âœ… ëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ í†µê³¼" >> $GITHUB_STEP_SUMMARY
          echo "ì‹œìŠ¤í…œì´ ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ì„ ë§Œì¡±í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
        else
          echo "## âš ï¸  ì¼ë¶€ ë³´ì•ˆ ê²€ì‚¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "ë³´ì•ˆ ì´ìŠˆë¥¼ ê²€í† í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
        fi